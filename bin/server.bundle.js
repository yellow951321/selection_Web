!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/bin",r(r.s=13)}([function(e,t,r){(function(e){var t=r(4);e&&(e.exports={map:{type:["大學","技專院校"],campus:{0:["中原大學","中山醫學大學","國立交通大學","國立東華大學","國立臺南大學","國立臺南藝術大學","國立臺灣大學","國立高雄師範大學","大同大學","大葉大學","康寧大學","逢甲大學","世新大學","中國醫藥大學","中華大學","元智大學","台灣首府大學","國立中興大學","國立宜蘭大學","國立屏東大學","國立成功大學","國立體育大學","明道大學","長榮大學","中國文化大學","佛光大學","國立中央大學","國立彰化師範大學","國立暨南國際大學","國立臺灣師範大學","國立臺灣海洋大學","東吳大學","玄奘大學","真理大學","臺北市立大學","開南大學","亞洲大學","南華大學","國立中山大學","國立政治大學","國立臺中教育大學","國立臺北藝術大學","國立金門大學","東海大學","法鼓文理學院","淡江大學","華梵大學","高雄醫學大學","一貫道天皇學院","國立嘉義大學","國立臺東大學","國立臺灣藝術大學","國立陽明大學","國立高雄大學","實踐大學","稻江科技暨管理學院","義守大學","輔仁大學","長庚大學","馬偕醫學院","中信金融管理學院","國立中正大學","國立清華大學","國立聯合大學","國立臺北大學","國立臺北教育大學","國立臺灣體育運動大學","國防醫學院","慈濟大學","臺北醫學大學","銘傳大學","靜宜大學"],1:["仁德醫護管理專科學校","健行科技大學","僑光科技大學","南臺科技大學","國立屏東科技大學","國立臺南護理專科學校","國立臺灣科技大學","大同技術學院","明志科技大學","聖約翰科技大學","萬能科技大學","醒吾科技大學","長庚科技大學","中華醫事科技大學","台北海洋科技大學","國立澎湖科技大學","國立臺北商業大學","國立雲林科技大學","崑山科技大學","嶺東科技大學","慈惠醫護管理專科學校","東南科技大學","輔英科技大學","遠東科技大學","馬偕醫護管理專科學校","高苑科技大學","中國科技大學","元培醫事科技大學","吳鳳科技大學","國立高雄應用科技大學","國立高雄海洋科技大學","國立高雄第一科技大學","德明財經科技大學","新生醫護管理專科學校","樹德科技大學","美和科技大學","聖母醫護管理專科學校","育達科技大學","臺北城市科技大學","中州科技大學","修平科技大學","南開科技大學","台南應用科技大學","國立勤益科技大學","國立臺灣戲曲學院","國立虎尾科技大學","崇右影藝科技大學","敏惠醫護管理專科學校","明新科技大學","樹人醫護管理專科學校","致理科技大學","龍華科技大學","亞太創意技術學院","南亞技術學院","南榮科技大學","和春技術學院","大漢技術學院","大華科技大學","蘭陽技術學院","亞東技術學院","嘉南藥理大學","國立臺中科技大學","國立臺北護理健康大學","宏國德霖科技大學","建國科技大學","弘光科技大學","文藻外語大學","朝陽科技大學","正修科技大學","耕莘健康管理專科學校","育英醫護管理專科學校","黎明技術學院","中臺科技大學","中華科技大學","國立臺北科技大學","國立臺東專科學校","國立高雄餐旅大學","大仁科技大學","崇仁醫護管理專科學校","慈濟科技大學","景文科技大學","東方設計大學","環球科技大學","經國管理暨健康學院","華夏科技大學"]},dimension:["教學","研究","產學","社會責任","大學治理及公共性"],item:["強化教學品質","跨領域學習","提高學習自由度及彈性","人才國際化","提升基礎能力","提升實作能力","提升專業/證照能力","數位化","資訊力","博雅教育","培養自主學習能力","培育創新創業人才","健康力","就業力","其他","提升研究能量","延攬優秀人才及留才","學術國際化","跨領域研究整合","其他","產學合作教學","建立/完善實習制度","產學合作研究","強化產學連結（不分教學研究）","落實研發成果","其他","與地方（或中央）政府連結","與非營利組織（NPO）連結","支援在地教育機構","促進地區（社區）發展","提供在地服務","打造永續校園","拓展國際社會服務","組織調整","強化招生","拓展財源","境外拓展","健全財務管理制度","推動校務研究（IR）","健全改革董事會（私校）","健全大學治理參與制度","增加弱勢生入學機會","弱勢學生支持系統","其他"],detail:["推廣創新教學模式","訂定核心能力，規劃課程地圖","強化課程內容","調整課程規劃","培育優良教學助教/人力","教師專業分享輔導機制","健全教師（學）評鑑制度","推動多元升等","健全教學獎勵制度","減輕教師教學負擔","建立教學改善回饋系統","課程外審","教學單位國際認證","成立教學品保委員會","提升教師群專業度","規劃跨領域學位（分）學程","鼓勵輔系、雙主修","跨領域教學","調降系必修學分","微學分（彈性學分）","開設入學前先修課程","深碗課程","增進外語能力","多元文化/文化交流","辦理海外參訪或移地教學","交換學生","雙聯學位","推動英語授課/全英語學程","生源國際化（及其配套措施）","國際學位學程/學院","招聘外籍老師（或邀請授課）","培養華語教學人才","強化國文能力","強化數理能力","強化寫作能力","強化表達溝通能力/領導能力","推動各類競賽（實作能力）","建立校外競賽鼓勵機制","呈現、檢核或評估實作成果","開設增進實務能力導向課程","聘請業師或雙師協同教學","提升教師實務能力","建立/強化實習制度","實施課程分流制度","開設證照專業課程","專業技能檢定之輔導機制","制訂專業證照獎勵辦法","學士後專業教育","其他","建置開放式線上課程","開發數位學習課程","教材雲端化","數位教學創新","電子學習歷程（e-Portfolio）","典藏文獻史料數位化","開設程式設計課程","開設資訊學程/課程","辦理程式設計競賽","強化基本資訊能力","通識課程革新","辦理藝術展覽或藝文活動","品德教育","服務學習","閱讀計畫補助","自主學習計畫獎勵機制","自主學習資源共享平台","激勵社團相關活動與競賽","住宿書院（及自主學習相關課程與活動）","創新創業學程或課程","育成學生創業團隊","建立完整的創業輔導機制","聘請業師參與育才","舉辦創業團隊競賽","發明展（或競賽）鼓勵機制","其他創業輔導及補助","促進學生生理健康","促進學生心理健康","強化職場連結","生涯/職涯輔導","就業博覽會","畢業生流向調查","雇主滿意度調查","充實與改善硬體設備","跨校學習資源整合與共享","學生輔導","制訂限期升等相關規範","增加授課時數制度彈性","強化落實評鑑制度","提供研究經費支援","提供研究人力支援","提供研究獎勵及補助","成立研究中心","與國內其他研究單位合作","設置研發創新獎項","前瞻性頂尖研究","辦理學術講座","提供研究分享輔導機制","落實彈性薪資","加強推動特聘講座制度","設立專款支援人才聘任","強化教師福利","吸引外籍人才相關措施","建立優秀人才資料庫","國際實驗室交流合作","跨國合作研究","成立跨國合作研究中心","雙聯博士學位","提供跨國進修機會","強化師生國際交流","招募國外博士後研究人才","跨領域合作研究案","發展跨領域研究學群","建立跨領域研究中心","充實硬體設備","培育研究型人才","強化學術研究倫理","開設產業專班/學院","依產業需求研訂課程/學程規劃","提升教師產業實務能力","產業實務知識融入教學","產業實務講座","建立/健全實習制度","強化實習課程/實習講座","檢驗/評估實習成果","加強企業實習合作","建立/強化企業實習平台","拓展海外實習機會","與企業單位合作研究","與企業合作設立研究中心","產學研究獎勵制度","修訂教師升等制度（強化產學研究）","成立產學合作研究園區","建立/強化產學溝通管道","成立/強化產學中心","整合跨校區域產學資源","拓展跨國產學合作","建立產學合作制度","成立/強化創新育成中心","成立/強化產學運籌中心","吸引創投基金","促進智財應用/技轉","推動衍生企業環境","扶植RSC新創事業","開設職業倫理課程/講座","技術開發","擔任政府智庫","提供研究調查服務","執行政策評估研究","配合政策提供專業資訊/服務","參與了解NPO社會需求","強化教師參與NPO","強化學生參與NPO","支援在地中小學教育","支援區域高中教育","區域學習資源共享","建置區域教學資源中心","參與了解地區（社區）需求","開設在地相關課程","協助在地社區規劃/改善","推廣/育成社會企業","籌設藝文/活動中心","服務特定群體","提供在地專業服務","發展/優化在地服務模式","發起/參與公益活動","參與在地文化、藝術工程計畫","升級永續校園綠設施","宣導永續校園概念及意識","強化永續校園制度管理","培植國際志工團隊","擴充國際志工服務","其他國際社會服務","組織定位及策略發展","組織重構","組織擴張","增設組織單位","裁撤組織單位","學院實體化方案","辦理高中生活動","辦理特殊選才","強化僑生、港澳生招生","拓展國外生源","設計招生制度性誘因","企業募款","經營校友會、系友會","調整學費","爭取政府經費補助","爭取非政府單位經費補助","強化進修推廣教育營收","附加營收多樣化","校務基金管理投資衍生收入","與國外學校合作開設境外學程或課程","與國外學校合作開設境外學位學程","開設境外分校","精簡行政縮減開支","資源分配控管制度化","建立財務透明稽核制度","校務基金決策機制透明化","建置校務資料系統","成立校務研究中心","發展校務研究","設定董事長及董事任期","聘任公益或獨立董事","董事遴選制度公開透明","建立資訊公開透明機制","健全學生參與機制","健全互動關係人參與機制","擴大繁星入學管道","增加身心障礙生入學機會","招收原住民學生/新移民子女","增加弱勢家庭子女入學機會","弱勢學生獎補助制度","建立/強化弱勢生支持系統","建立外部募款基金","平衡人文社會及自然科學領域發展","強化行政職能","建立計畫管考機制","基礎建設及硬體設備提升","提升學校知名度","增進師生福利"]},getFromWord:function e(t,r){if(r.campus){var n=e(t,{type:r.type}).toString();return t.campus[n].indexOf(r.campus)}for(var a in r)return t[a].indexOf(r[a])},getFromNum:function(e,t){if(void 0!==t.campus)return e.campus[t.type][t.campus];for(var r in t)return e[r][t[r]]},findParentByDetail:function(e){var r,n=t.readFileSync("data/projectSchema.json","utf-8");for(var a in n=JSON.parse(n))for(var o in n[a])for(var s in n[a][o])s===e&&(r={dimension:a,item:o,detail:e});return r}})}).call(this,r(16)(e))},function(e,t){e.exports=require("express")},function(e,t){e.exports={database:{host:"127.0.0.1",port:3306,user:"shao",password:"qq5aa789"},server:{domain:"localhost",port:3e3,secret:"deepest and darkest secret"},projectRoot:"/home/ccs100203/Desktop/Coding/selection_Web"}},function(e,t){e.exports=require("sequelize")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("babel-types")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("csv-writer")},function(e,t){e.exports=require("unique-filename")},function(e,t,r){r(14),e.exports=r(17)},function(e,t){e.exports=require("babel-polyfill")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,r){"use strict";r.r(t);var n=r(8),a=r.n(n),o=r(1),s=r.n(o),c=(r(15),r(9)),i=r.n(c),u=r(6),d=r.n(u),p=(r(10),r(5)),l=r.n(p),m=r(2),f=r.n(m),h=r(3),v=r.n(h),y=new v.a("sinicaUser","".concat(f.a.database.user),"".concat(f.a.database.password),{host:"".concat(f.a.database.host),port:f.a.database.port,dialect:"mysql",omitNull:!0,native:!0,logging:!1,define:{underscored:!0,charset:"utf-8",freezeTableName:!0,dialectOptions:{collate:"utf8mb4_general_ci"},timestamps:!1},operatorsAliases:!1,sync:{force:!1},pool:{max:5,min:0,acquire:3e4,idle:3e4}}),I=y.define("session",{tableId:{type:v.a.INTEGER(32).UNSIGNED,primaryKey:!0,allowNull:!1,unique:!0,autoIncrement:!0},sessionId:{type:v.a.STRING(45),allowNull:!1,unique:!0},expiration:{type:v.a.STRING(45),allowNull:!1},userId:{type:v.a.INTEGER(32).UNSIGNED,allowNull:!1}}),g=r(4),w=r.n(g),b=y.define("user",{userId:{type:v.a.INTEGER(32).UNSIGNED,primaryKey:!0,allowNull:!1,unique:!0,autoIncrement:!0},account:{type:v.a.STRING(20),allowNull:!1,unique:!0},password:{type:v.a.STRING(20),allowNull:!1}}),x=r(0);function k(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function N(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){k(o,n,a,s,c,"next",e)}function c(e){k(o,n,a,s,c,"throw",e)}s(void 0)})}}var R=s()();R.set("views",l.a.join(f.a.projectRoot,"auth/views")),R.set("view engine","pug"),R.use("/static",s.a.static("".concat(f.a.projectRoot,"/auth/public"),{cacheControl:!1,dotfiles:"ignore",etag:!1,extensions:["css","js"],fallthrough:!0,immutable:!1,index:!1,lastModified:!1,maxAge:0,redirect:!1,setHeaders:function(e,t,r){e.set("x-timestamp",Date.now())}})),R.get("/login",function(){var e=N(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.session&&t.session.userId?r.redirect("/auth/channel"):r.render("login");case 1:case"end":return e.stop()}},e)}));return function(t,r){return e.apply(this,arguments)}}()),R.get("/channel",function(){var e=N(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.session||!t.session.userId){e.next=8;break}return e.next=3,b.findOne({where:{userId:t.session.userId}});case 3:null!=(n=e.sent)&&(n=n.dataValues),r.render("manage/channel",{GLOBAL:{id:t.session.userId,user:n.account,map:x.map.campus}}),e.next=9;break;case 8:r.render("login");case 9:case"end":return e.stop()}},e)}));return function(t,r){return e.apply(this,arguments)}}()),R.get("/mid-long-term",function(e,t){e.session&&e.session.userId?t.redirect("/mid-long-term/index"):t.render("login")}),R.get("/shortTerm",function(e,t){e.session&&e.session.userId?t.redirect("/shortTerm/index"):t.render("login")}),R.post("/login",function(){var e=N(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,b.findOne({where:{account:t.body.username,password:t.body.password}});case 3:if(null==(n=e.sent)){e.next=10;break}t.session.userId=n.dataValues.userId,I.create({sessionId:t.session.id,expiration:Number(t.session.cookie.expires),userId:n.userId}),r.redirect("/auth/login"),e.next=11;break;case 10:throw new Error("No account matched ".concat(t.body.username));case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),r.status(400).render("login",{error:e.t0.message});case 16:case"end":return e.stop()}},e,null,[[0,13]])}));return function(t,r){return e.apply(this,arguments)}}()),R.get("/logout",function(){var e=N(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,I.destroy({where:{sessionId:t.session.id}});case 3:return e.next=5,new Promise(function(e,r){t.session.destroy(function(t){t&&r(t),e()})}).catch(function(e){throw e});case 5:r.status(200).redirect("/auth/login"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),r.status(404).render("error",{message:e.t0.message,error:{status:"404",stack:"error"}});case 11:case"end":return e.stop()}},e,null,[[0,8]])}));return function(t,r){return e.apply(this,arguments)}}()),R.get("/signup",function(e,t){t.render("signup")}),R.post("/signup",function(){var e=N(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=new RegExp("<script[sS]*?>[sS]*?<\/script>","gi"),e.prev=1,!n.test(t.body.username)&&!n.test(t.body.password)){e.next=4;break}throw new Error("Forbidden password or account");case 4:return e.next=6,b.create({account:t.body.username,password:t.body.password});case 6:if(!e.sent){e.next=10;break}return e.next=10,new Promise(function(e,r){w.a.mkdir("data/".concat(t.body.username),{recursive:!0},function(t){t&&r(t),e(!0)})});case 10:r.status(200).send("OK"),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(1),r.status(400).render("signup",{error:e.t0.message});case 16:case"end":return e.stop()}},e,null,[[1,13]])}));return function(t,r){return e.apply(this,arguments)}}());var O=R,F=new v.a("sinicaMidLongTerm","".concat(f.a.database.user),"".concat(f.a.database.password),{host:"".concat(f.a.database.host),port:f.a.database.port,dialect:"mysql",omitNull:!1,native:!0,define:{underscored:!0,charset:"utf-8",freezeTableName:!0,dialectOptions:{collate:"utf8mb4_general_ci"},timestamps:!1},operatorsAliases:!1,sync:{force:!1},pool:{max:100,min:0,acquire:1e6,idle:2e5}}),j=r(3),T={dataId:{type:j.INTEGER(32).UNSIGNED,primaryKey:!0,allowNull:!1,unique:!0,autoIncrement:!0},campusId:{type:j.TINYINT(8).UNSIGNED,allowNull:!1},typeId:{type:j.TINYINT(8).UNSIGNED,allowNull:!1},yearFrom:{type:j.TINYINT(8).UNSIGNED,allowNull:!1},yearTo:{type:j.TINYINT(8).UNSIGNED,allowNull:!1},userId:{type:j.INTEGER(32).UNSIGNED,allowNull:!1}},P=F.define("data",T),S=r(3),E={contentId:{type:S.INTEGER(32).UNSIGNED,primaryKey:!0,allowNull:!1,unqiue:!0,autoIncrement:!0},title1:{type:S.STRING(200),allowNull:!0},title2:{type:S.STRING(200),allowNull:!0},title3:{type:S.STRING(200),allowNull:!0},title4:{type:S.STRING(200),allowNull:!0},content:{type:S.STRING(1e3),allowNull:!0},summary:{type:S.STRING(200),allowNull:!0},note:{type:S.STRING(1e3),allowNull:!0},pageFrom:{type:S.INTEGER(10).UNSIGNED,allowNull:!1},pageTo:{type:S.INTEGER(10).UNSIGNED,allowNull:!1,unqiue:!0},aspect:{type:S.TINYINT(8),allowNull:!1},keypoint:{type:S.TINYINT(8),allowNull:!1},method:{type:S.TINYINT(8).UNSIGNED,allowNull:!1},isChecked:{type:S.TINYINT(1),allowNull:!1},reviewerId:{type:S.INTEGER(32).UNSIGNED,allowNull:!0},isConflicted:{type:S.TINYINT(1),allowNull:!1},conflictedAspect:{type:S.TINYINT(8).UNSIGNED,allowNull:!0},conflictedKeypoint:{type:S.TINYINT(8).UNSIGNED,allowNull:!0},conflictedMethod:{type:S.TINYINT(8).UNSIGNED,allowNull:!0},updateTime:{type:S.DATE,allowNull:!1},dataId:{type:S.INTEGER(32).UNSIGNED,allowNull:!1}},G=F.define("content",E);function A(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function q(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){A(o,n,a,s,c,"next",e)}function c(e){A(o,n,a,s,c,"throw",e)}s(void 0)})}}b.hasMany(P,{as:"data",foreignkey:"userId",sourceKey:"userId"}),P.hasMany(G,{as:"content",foreignkey:"dataId",sourceKey:"dataId"});var C=function(){var e=q(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,P.findAll({where:{},attributes:["dataId","campusId","typeId","yearFrom","yearTo","userId"]});case 3:return r=(r=(r=e.sent).map(function(e){return e.dataValues.typeId})).filter(function(e,t,r){return r.indexOf(e)===t}),e.abrupt("return",r);case 9:throw e.prev=9,e.t0=e.catch(0),e.t0;case 12:case"end":return e.stop()}},e,null,[[0,9]])}));return function(t){return e.apply(this,arguments)}}(),D=function(){var e=q(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,P.findAll({where:{typeId:r},attributes:["dataId","campusId","typeId","yearFrom","yearTo","userId"]});case 3:return n=(n=(n=e.sent).map(function(e){return e.dataValues.campusId})).filter(function(e,t,r){return r.indexOf(e)===t}),e.abrupt("return",n);case 9:e.prev=9,e.t0=e.catch(0),console.log(e.t0);case 12:case"end":return e.stop()}},e,null,[[0,9]])}));return function(t,r){return e.apply(this,arguments)}}(),W=function(){var e=q(regeneratorRuntime.mark(function e(){var t,r,n=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:{},e.prev=1,e.next=4,P.findAll({where:{typeId:t.typeId,campusId:t.campusId},attributes:["dataId","campusId","typeId","yearFrom","yearTo","userId"]});case 4:return(r=e.sent).map(function(e){return e.dataValues}),e.abrupt("return",r);case 9:e.prev=9,e.t0=e.catch(1),console.log(e.t0);case 12:case"end":return e.stop()}},e,null,[[1,9]])}));return function(){return e.apply(this,arguments)}}(),V=function(){var e=q(regeneratorRuntime.mark(function e(){var t,r,n,a=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:{},e.prev=1,e.next=4,P.findOne({where:{campusId:t.campusId,typeId:t.type}});case 4:if(null!=(r=e.sent)){e.next=9;break}return e.abrupt("return",null);case 9:n=r.dataNew;case 10:return e.abrupt("return",n);case 13:e.prev=13,e.t0=e.catch(1),console.log(e.t0);case 16:case"end":return e.stop()}},e,null,[[1,13]])}));return function(){return e.apply(this,arguments)}}(),L=function(){var e=q(regeneratorRuntime.mark(function e(){var t,r=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},e.prev=1,e.next=4,V(t);case 4:return e.sent,e.abrupt("return",P.create({campusId:t.campusId,typeId:t.type,userId:t.userId,yearFrom:t.yearFrom,yearTo:t.yearTo}));case 8:e.prev=8,e.t0=e.catch(1),console.log(e.t0);case 11:case"end":return e.stop()}},e,null,[[1,8]])}));return function(){return e.apply(this,arguments)}}(),U=function(){var e=q(regeneratorRuntime.mark(function e(t){var r,n,a,o,s,c,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.findAll({where:{dataId:t},attributes:["contentId","isChecked","isConflicted","updateTime"]});case 3:return r=(r=e.sent).map(function(e){return e.dataValues}),n=0,a=0,o=0,s=-1,c=-1,i=-1,r.map(function(e){0==e.isChecked&&0==e.isConflicted?n+=1:1==e.isChecked?a+=1:0==e.isChecked&&1==e.isConflicted&&(o+=1);var t=e.updateTime.split("-"),r=Number(t[0]),u=Number(t[1]),d=Number(t[2]);s<r?(s=r,c=u,i=d):s==r&&c<u?(s=r,c=u,i=d):c==u&&i<d&&(s=r,c=u,i=d)}),u=(a/(a+o+n)*100).toFixed(2),e.abrupt("return",{progression:u,unsolved:0==o?"No":"Yes",updateTime:String("".concat(s,"-").concat(c,"-").concat(i))});case 12:e.prev=12,e.t0=e.catch(0),console.log(e.t0);case 15:case"end":return e.stop()}},e,null,[[0,12]])}));return function(t){return e.apply(this,arguments)}}(),M=function(){var e=q(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r={},e.next=4,Promise.all(t.map(function(){var e=q(regeneratorRuntime.mark(function e(t){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,U(t.dataId);case 2:return n=e.sent,e.next=5,b.findOne({where:{userId:t.userId}});case 5:a=e.sent,r.hasOwnProperty(t.yearFrom)?r[t.yearFrom].push({year:t.yearTo,dataId:t.dataId,progression:n.progression,unsolved:n.unsolved,time:n.updateTime,user:{id:a.userId,name:a.account}}):(r[t.yearFrom]=[],r[t.yearFrom].push({year:t.yearTo,dataId:t.dataId,progression:n.progression,unsolved:n.unsolved,time:n.updateTime,user:{id:a.userId,name:a.account}}));case 7:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 4:return n=[],Object.keys(r).map(function(e){n.push({year:e,info:r[e]})}),e.abrupt("return",n);case 9:e.prev=9,e.t0=e.catch(0),console.log(e.t0);case 12:case"end":return e.stop()}},e,null,[[0,9]])}));return function(t){return e.apply(this,arguments)}}(),K=function(){var e=q(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,P.findAll({where:{campusId:t},attributes:["dataId"]});case 3:return r=(r=e.sent).map(function(e){return e.dataValues.dataId}),e.next=7,G.max("updateTime",{where:{dataId:(a={},o=h.Op.or,s=r,o in a?Object.defineProperty(a,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):a[o]=s,a)}});case 7:return n=e.sent,e.abrupt("return",n);case 11:e.prev=11,e.t0=e.catch(0),console.log(e.t0);case 14:case"end":return e.stop()}var a,o,s},e,null,[[0,11]])}));return function(t){return e.apply(this,arguments)}}(),B=function(){var e=q(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.abrupt("return",P.destroy({where:{dataId:t}}).then(function(){return"ok"}).catch(function(){throw new Error("No specified project")}));case 4:e.prev=4,e.t0=e.catch(0),console.log(e.t0);case 7:case"end":return e.stop()}},e,null,[[0,4]])}));return function(t){return e.apply(this,arguments)}}();function Y(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}var _=s.a.Router();_.get("/index",function(){var e,t=(e=regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,C(t.session.userId);case 3:return n=e.sent,e.next=6,n.map(function(e){return{name:Object(x.getFromNum)(x.map,{type:e}),id:e}});case 6:n=e.sent,r.render("manage/type",{GLOBAL:{channel:{id:"mid-long-term",name:"中長程計畫"},id:t.session.userId,user:r.locals.user,map:x.map.campus,types:n}}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),console.log(e.t0);case 13:case"end":return e.stop()}},e,null,[[0,10]])}),function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){Y(o,n,a,s,c,"next",e)}function c(e){Y(o,n,a,s,c,"throw",e)}s(void 0)})});return function(e,r){return t.apply(this,arguments)}}());var z=_;function H(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function J(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){H(o,n,a,s,c,"next",e)}function c(e){H(o,n,a,s,c,"throw",e)}s(void 0)})}}var Q=s.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});Q.get("/",function(){var e=J(regeneratorRuntime.mark(function e(t,r){var n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,P.findOne({where:{dataId:r.locals.dataId},attributes:["dataId"]});case 3:if(e.sent.dataValues.userId!==t.session.userId){e.next=7;break}return r.redirect("/mid-long-term/".concat(r.locals.typeId,"/").concat(r.locals.campusId,"/").concat(r.locals.dataId,"/edit/file")),e.abrupt("return");case 7:return e.next=9,G.findAll({where:{dataId:r.locals.dataId},attributes:["contentId","dataId","title1","title2","title3","title4","note","content","pageFrom","pageTo","aspect","keypoint","method","isChecked","conflictedAspect","conflictedKeypoint","conflictedMethod","reviewerId","updateTime"]});case 9:return n=e.sent,e.next=12,Promise.all(n.map(function(){var e=J(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.dataValues).aspect=Object(x.getFromNum)(x.map,{dimension:r.aspect}),r.keypoint=Object(x.getFromNum)(x.map,{item:r.keypoint}),r.method=Object(x.getFromNum)(x.map,{detail:r.method}),r.conflictedAspect=Object(x.getFromNum)(x.map,{dimension:r.conflictedAspect}),r.conflictedKeypoint=Object(x.getFromNum)(x.map,{item:r.conflictedKeypoint}),r.conflictedMethod=Object(x.getFromNum)(x.map,{detail:r.conflictedMethod}),!r.reviewerId){e.next=12;break}return e.next=10,b.findOne({where:{userId:r.reviewerId}});case 10:r.reviewerId=e.sent,r.reviewerId=r.reviewerId.dataValues.account;case 12:return e.abrupt("return",r);case 13:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 12:n=e.sent,a=Object(x.getFromNum)(x.map,{type:r.locals.typeId}),o=Object(x.getFromNum)(x.map,{type:r.locals.typeId,campus:r.locals.campusId}),r.render("manage/review.pug",{GLOBAL:{channel:{id:"mid-long-term",name:"中長程計畫"},id:t.session.userId,user:r.locals.user,type:{id:r.locals.typeId,name:a},campus:{id:r.locals.campusId,name:o},contents:n}}),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(0),r.sendStatus(404);case 21:case"end":return e.stop()}},e,null,[[0,18]])}));return function(t,r){return e.apply(this,arguments)}}()),Q.post("/conflict",function(){var e=J(regeneratorRuntime.mark(function e(t,r){var n,a,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.findOne({where:{contentId:t.body.contentId},attributes:["contentId"]});case 3:return n=e.sent,a=Object(x.getFromWord)(x.map,{dimension:t.body.conflictedAspect}),o=Object(x.getFromWord)(x.map,{item:t.body.conflictedKeypoint}),s=Object(x.getFromWord)(x.map,{detail:t.body.conflictedMethod}),e.next=9,n.update({conflictedAspect:a,conflictedKeypoint:o,conflictedMethod:s,isConflicted:1,reviewerId:t.session.userId});case 9:if(!e.sent){e.next=14;break}r.send("completed"),e.next=15;break;case 14:throw new Error("failed");case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),r.status(404);case 20:case"end":return e.stop()}},e,null,[[0,17]])}));return function(t,r){return e.apply(this,arguments)}}()),Q.post("/check",function(){var e=J(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log(123),e.next=4,G.findOne({where:{contentId:t.body.contentId},attributes:["contentId"]});case 4:return n=e.sent,e.next=7,n.update({reviewerId:t.session.userId,isChecked:1});case 7:if(!e.sent){e.next=12;break}r.send("completed"),e.next=13;break;case 12:throw new Error("failed");case 13:e.next=17;break;case 15:e.prev=15,e.t0=e.catch(0);case 17:case"end":return e.stop()}},e,null,[[0,15]])}));return function(t,r){return e.apply(this,arguments)}}());var X=Q;function Z(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function $(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){Z(o,n,a,s,c,"next",e)}function c(e){Z(o,n,a,s,c,"throw",e)}s(void 0)})}}var ee=s.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});ee.get("/index",function(){var e=$(regeneratorRuntime.mark(function e(t,r){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,D(t.session.userId,r.locals.typeId);case 3:return n=e.sent,e.next=6,Promise.all(n.map(function(){var e=$(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,K(t);case 2:return n=e.sent,n=(n=JSON.stringify(n).split("T"))[0].split('"'),e.abrupt("return",{id:t,name:Object(x.getFromNum)(x.map,{type:r.locals.typeId,campus:t}),time:n[1]});case 6:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 6:n=e.sent,a=Object(x.getFromNum)(x.map,{type:r.locals.typeId}),r.render("manage/campus",{GLOBAL:{channel:{id:"mid-long-term",name:"中長程計畫"},id:t.session.userId,user:r.locals.user,map:x.map.campus,type:{id:r.locals.typeId,name:a},campuses:n}}),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),console.log(e.t0);case 14:case"end":return e.stop()}},e,null,[[0,11]])}));return function(t,r){return e.apply(this,arguments)}}()),ee.post("/file/add",function(){var e=$(regeneratorRuntime.mark(function e(t,r){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{n=0==t.body.type?"大學":"技專院校",a=Object(x.getFromWord)(x.map,{type:n,campus:t.body.campus}),insertCampus({campusId:a,year:t.body.year,type:t.body.type,userId:t.session.userId}),r.redirect("/mid-long-term/".concat(r.locals.typeId,"/index"))}catch(e){console.log(e)}case 1:case"end":return e.stop()}},e)}));return function(t,r){return e.apply(this,arguments)}}());var te=ee;r(7);function re(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}var ne=s.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});ne.get("/index",function(){var e,t=(e=regeneratorRuntime.mark(function e(t,r){var n,a,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,W({typeId:r.locals.typeId,campusId:r.locals.campusId});case 3:return n=e.sent,a=Object(x.getFromNum)(x.map,{type:r.locals.typeId}),o=Object(x.getFromNum)(x.map,{type:r.locals.typeId,campus:r.locals.campusId}),e.next=8,M(n);case 8:s=e.sent,r.render("manage/year",{GLOBAL:{channel:{id:"mid-long-term",name:"中長程計畫"},id:t.session.userId,user:r.locals.user,map:x.map.campus,type:{id:r.locals.typeId,name:a},campus:{id:r.locals.campusId,name:o},yearFroms:s}}),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),console.log(e.t0);case 15:case"end":return e.stop()}},e,null,[[0,12]])}),function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){re(o,n,a,s,c,"next",e)}function c(e){re(o,n,a,s,c,"throw",e)}s(void 0)})});return function(e,r){return t.apply(this,arguments)}}());var ae=ne;function oe(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function se(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){oe(o,n,a,s,c,"next",e)}function c(e){oe(o,n,a,s,c,"throw",e)}s(void 0)})}}var ce=s.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});ce.post("/add",function(){var e=se(regeneratorRuntime.mark(function e(t,r){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{n=0==t.body.type?"大學":"技專院校",a=Object(x.getFromWord)(x.map,{type:n,campus:t.body.campus}),L({campusId:a,yearFrom:t.body.yearFrom,yearTo:t.body.yearTo,type:t.body.type,userId:t.session.userId}),r.redirect("/mid-long-term/".concat(t.body.type,"/index"))}catch(e){console.log(e)}case 1:case"end":return e.stop()}},e)}));return function(t,r){return e.apply(this,arguments)}}()),ce.delete("/delete",function(){var e=se(regeneratorRuntime.mark(function e(t,r){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,P.findOne({where:{campusId:r.locals.campusId,typeId:r.locals.typeId,yearFrom:r.locals.year,yearTo:r.locals.year,userId:t.session.userId},attributes:["dataId"]});case 3:if(n=e.sent,null==(a=n.dataValues)){e.next=12;break}return e.next=8,B(a.dataId);case 8:console.log("deletion procedure is conpleted"),r.send("OK"),e.next=13;break;case 12:throw new Error("No specified dataId");case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),console.log(e.t0);case 18:case"end":return e.stop()}},e,null,[[0,15]])}));return function(t,r){return e.apply(this,arguments)}}()),ce.get("/edit",function(){var e=se(regeneratorRuntime.mark(function e(t,r){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,P.findOne({where:{dataId:r.locals.dataId},attributes:["dataId","userId"]});case 3:if(e.sent.dataValues.userId===t.session.userId){e.next=7;break}return r.redirect("/mid-long-term/".concat(r.locals.typeId,"/").concat(r.locals.campusId,"/").concat(r.locals.dataId,"/review")),e.abrupt("return");case 7:n=Object(x.getFromNum)(x.map,{type:r.locals.typeId}),a=Object(x.getFromNum)(x.map,{type:r.locals.typeId,campus:r.locals.campusId}),r.render("manage/edit",{GLOBAL:{channel:{id:"mid-long-term",name:"中長程計畫"},id:t.session.userId,dataId:r.locals.dataId,user:r.locals.user,type:{id:r.locals.typeId,name:n},campus:{id:r.locals.campusId,name:a}}}),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),console.log(e.t0);case 15:case"end":return e.stop()}},e,null,[[0,12]])}));return function(t,r){return e.apply(this,arguments)}}());var ie=ce;function ue(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function de(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){ue(o,n,a,s,c,"next",e)}function c(e){ue(o,n,a,s,c,"throw",e)}s(void 0)})}}var pe=s.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});pe.get("/index",function(){var e=de(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},e)}));return function(t,r){return e.apply(this,arguments)}}()),pe.get("/filter",function(){var e=de(regeneratorRuntime.mark(function e(t,r){var n,a,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=Object(x.getFromWord)(x.map,{dimension:t.query.dimension}),a=Object(x.getFromWord)(x.map,{item:t.query.item}),o=Object(x.getFromWord)(x.map,{detail:t.query.detail}),e.next=6,G.findAll({where:{dataId:r.locals.dataId,aspect:n,keypoint:a,method:o},attributes:["contentId","title1","title2","title3","title4","content","summary","note","pageFrom","pageTo","aspect","keypoint","method","isChecked","reviewerId","isConflicted","updateTime","dataId"]});case 6:return(s=e.sent)===[]&&r.send("empty"),e.next=10,Promise.all(s.map(function(){var e=de(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=t.dataValues).reviewerId){e.next=6;break}return e.next=4,b.findOne({where:{userId:r.reviewerId}});case 4:r.reviewerId=e.sent,r.reviewerId=r.reviewerId.dataValues.account;case 6:return e.abrupt("return",r);case 7:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 10:s=e.sent,r.render("manage/component/editNodes/own",{GLOBAL:{contents:s}}),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),r.status(409).render("error",{message:e.t0,error:{status:e.t0.status}});case 17:case"end":return e.stop()}},e,null,[[0,14]])}));return function(t,r){return e.apply(this,arguments)}}()),pe.get("/check",function(){var e=de(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.findAll({where:{dataId:r.locals.dataId,isConflicted:1,isChecked:0},attributes:["content","summary","note","reviewerId","title1","title2","title3","title4","pageFrom","pageTo","contentId","conflictedAspect","conflictedKeypoint","conflictedMethod"]});case 3:return(n=e.sent)===[]&&r.send("empty"),e.next=7,Promise.all(n.map(function(){var e=de(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(r=t.dataValues).aspect=Object(x.getFromNum)(x.map,{dimension:r.aspect}),r.keypoint=Object(x.getFromNum)(x.map,{item:r.keypoint}),r.method=Object(x.getFromNum)(x.map,{detail:r.method}),r.conflictedAspect=Object(x.getFromNum)(x.map,{dimension:r.conflictedAspect}),r.conflictedKeypoint=Object(x.getFromNum)(x.map,{item:r.conflictedKeypoint}),r.conflictedMethod=Object(x.getFromNum)(x.map,{detail:r.conflictedMethod}),e.abrupt("return",r);case 8:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 7:n=e.sent,r.render("manage/component/editNodes/check",{GLOBAL:{contents:n}}),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),r.status(409).render("error",{message:e.t0,error:{status:e.t0.status}});case 14:case"end":return e.stop()}},e,null,[[0,11]])}));return function(t,r){return e.apply(this,arguments)}}()),pe.post("/check",function(){var e=de(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.findOne({where:{contentId:t.body.contentId},attributes:["contentId","isChecked"]});case 3:return n=e.sent,e.next=6,n.update({isChecked:1,isConflicted:0});case 6:if(!e.sent){e.next=11;break}r.send("completed"),e.next=12;break;case 11:throw new Error("save failed");case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),r.sendStatus(404);case 17:case"end":return e.stop()}},e,null,[[0,14]])}));return function(t,r){return e.apply(this,arguments)}}()),pe.post("/change",function(){var e=de(regeneratorRuntime.mark(function e(t,r){var n,a,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.findOne({where:{contentId:t.body.contentId},attributes:["contentId"]});case 3:return n=e.sent,a=Object(x.getFromWord)(x.map,{dimension:t.body.aspect}),o=Object(x.getFromWord)(x.map,{item:t.body.keypoint}),s=Object(x.getFromWord)(x.map,{detail:t.body.method}),e.next=9,n.update({isChecked:1,isConflicted:0,aspect:a,keypoint:o,method:s,conflictedAspect:null,conflictedKeypoint:null,conflictedMethod:null});case 9:if(!e.sent){e.next=14;break}r.send("completed"),e.next=15;break;case 14:throw new Error("save failed");case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(0),console.log(e.t0),r.sendStatus(404);case 21:case"end":return e.stop()}},e,null,[[0,17]])}));return function(t,r){return e.apply(this,arguments)}}()),pe.post("/add",function(){var e=de(regeneratorRuntime.mark(function e(t,r){var n,a,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=Object(x.getFromWord)(x.map,{dimension:t.body.dimension}),a=Object(x.getFromWord)(x.map,{item:t.body.item}),o=Object(x.getFromWord)(x.map,{detail:t.body.detail}),e.next=6,G.create({dataId:r.locals.dataId,title1:"",title2:"",title3:"",title4:"",content:"",pageFrom:1,pageTo:1,aspect:n,keypoint:a,method:o,isChecked:0,reviewerId:0,isConflicted:0,updateTime:Date.now()});case 6:s=e.sent,r.render("manage/component/editNodes/newEdit",{GLOBAL:{index:s.dataValues.contentId}}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),r.status(404);case 13:case"end":return e.stop()}},e,null,[[0,10]])}));return function(t,r){return e.apply(this,arguments)}}()),pe.post("/save",function(){var e=de(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.findOne({where:{contentId:t.body.contentId},attributes:["contentId"]});case 3:return n=e.sent,e.next=6,n.update({content:t.body.content,summary:t.body.summary,note:t.body.note,reviewerId:t.body.auditor,title1:t.body.title1,title2:t.body.title2,title3:t.body.title3,title4:t.body.title4,pageFrom:t.body.page.start,pageTo:t.body.page.end,contentId:t.body.contentId,isChecked:0,isConflicted:0,conflictedAspect:null,conflictedKeypoint:null,conflictedMethod:null});case 6:if(!e.sent){e.next=11;break}r.send("completed"),e.next=12;break;case 11:throw new Error("save failed");case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),r.status(404);case 17:case"end":return e.stop()}},e,null,[[0,14]])}));return function(t,r){return e.apply(this,arguments)}}()),pe.delete("/delete",function(){var e=de(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.destroy({where:{contentId:t.body.contentId}});case 3:e.sent,r.send("completed"),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(404);case 10:case"end":return e.stop()}},e,null,[[0,7]])}));return function(t,r){return e.apply(this,arguments)}}());var le=pe,me=r(11),fe=r(12),he=r.n(fe);function ve(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}var ye=s.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});ye.get("/index",function(){var e,t=(e=regeneratorRuntime.mark(function e(t,r){var n,a,o,s,c,i,u,d,p,l,m,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n="/tmp/selection_Web",w.a.existsSync(n)||w.a.mkdirSync(n),a=he()(n),o=Object(me.createObjectCsvWriter)({path:a,header:[{id:"aspect",title:"構面"},{id:"keypoint",title:"推動重點"},{id:"method",title:"具體作法"},{id:"title1",title:"大標題"},{id:"title2",title:"中標題"},{id:"title3",title:"小標題"},{id:"title4",title:"最小標題"},{id:"content",title:"內容"}]}),s=[],e.next=8,G.findAll({where:{dataId:r.locals.dataId},attributes:["contentId","title1","title2","title3","title4","content","summary","note","aspect","keypoint","method"]}).then(function(e){return e}).catch(function(e){throw e});case 8:for(c=(c=e.sent).map(function(e){return e.dataValues}),i=!0,u=!1,d=void 0,e.prev=13,p=c[Symbol.iterator]();!(i=(l=p.next()).done);i=!0)m=l.value,s.push({aspect:Object(x.getFromNum)(x.map,{dimension:m.aspect}),keypoint:Object(x.getFromNum)(x.map,{item:m.keypoint}),method:Object(x.getFromNum)(x.map,{detail:m.method}),title1:m.title1,title2:m.title2,title3:m.title3,title4:m.title4,content:m.content});e.next=21;break;case 17:e.prev=17,e.t0=e.catch(13),u=!0,d=e.t0;case 21:e.prev=21,e.prev=22,i||null==p.return||p.return();case 24:if(e.prev=24,!u){e.next=27;break}throw d;case 27:return e.finish(24);case 28:return e.finish(21);case 29:return e.next=31,o.writeRecords(s);case 31:f={root:"/",dotfiles:"deny",headers:{"content-type":"text/csv","Content-Disposition":"attachment;filename=".concat(encodeURIComponent(t.params.campusName),".csv")}},r.sendFile(a,f,function(e){if(e)throw e;w.a.unlink(a,function(e){if(e)throw e})}),e.next=38;break;case 35:e.prev=35,e.t1=e.catch(0),console.log(e.t1);case 38:case"end":return e.stop()}},e,null,[[0,35],[13,17,21,29],[22,,24,28]])}),function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){ve(o,n,a,s,c,"next",e)}function c(e){ve(o,n,a,s,c,"throw",e)}s(void 0)})});return function(e,r){return t.apply(this,arguments)}}());var Ie=ye;function ge(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function we(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){ge(o,n,a,s,c,"next",e)}function c(e){ge(o,n,a,s,c,"throw",e)}s(void 0)})}}var be=function(){var e=we(regeneratorRuntime.mark(function e(){var t,r,n,a=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:{},e.prev=1,e.next=4,G.findAll({where:{dataId:t.dataId},attributes:["aspect","keypoint","method","dataId"],group:["method"]}).then(function(e){return e.map(function(e){return e.dataValues})});case 4:return r=e.sent,e.next=7,Promise.all(r.map(function(e){return G.count({attributes:["dataId"],where:{aspect:e.aspect,keypoint:e.keypoint,method:e.method},group:["dataId"]}).then(function(t){return t=t.sort(function(e,t){return e.count-t.count}),{aspect:Object(x.getFromNum)(x.map,{dimension:e.aspect}),keypoint:Object(x.getFromNum)(x.map,{item:e.keypoint}),method:Object(x.getFromNum)(x.map,{detail:e.method}),methodId:e.method,selfId:e.dataId,data:t}})}));case 7:return n=e.sent,e.abrupt("return",n);case 11:e.prev=11,e.t0=e.catch(1),console.log(e.t0);case 14:case"end":return e.stop()}},e,null,[[1,11]])}));return function(){return e.apply(this,arguments)}}(),xe=function(){var e=we(regeneratorRuntime.mark(function e(){var t,r,n,a=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:{},e.prev=1,e.next=4,G.findAll({where:{dataId:t.dataId,aspect:t.aspect},attributes:["aspect","keypoint","method","dataId"],group:["method"]}).then(function(e){return e.map(function(e){return e.dataValues})});case 4:return r=e.sent,e.next=7,Promise.all(r.map(function(e){return G.count({attributes:["dataId"],where:{aspect:e.aspect,keypoint:e.keypoint,method:e.method},group:["dataId"]}).then(function(t){return t=t.sort(function(e,t){return e.count-t.count}),{aspect:Object(x.getFromNum)(x.map,{dimension:e.aspect}),keypoint:Object(x.getFromNum)(x.map,{item:e.keypoint}),method:Object(x.getFromNum)(x.map,{detail:e.method}),methodId:e.method,selfId:e.dataId,data:t}})}));case 7:return n=e.sent,e.abrupt("return",n);case 11:e.prev=11,e.t0=e.catch(1),console.log(e.t0);case 14:case"end":return e.stop()}},e,null,[[1,11]])}));return function(){return e.apply(this,arguments)}}(),ke=function(){var e=we(regeneratorRuntime.mark(function e(){var t,r,n,a=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:{},e.prev=1,e.next=4,G.findAll({where:{dataId:t.dataId,aspect:t.aspect,keypoint:t.keypoint},attributes:["aspect","keypoint","method","dataId"],group:["method"]}).then(function(e){return e.map(function(e){return e.dataValues})});case 4:return r=e.sent,e.next=7,Promise.all(r.map(function(e){return G.count({attributes:["dataId"],where:{aspect:e.aspect,keypoint:e.keypoint,method:e.method},group:["dataId"]}).then(function(t){return t=t.sort(function(e,t){return e.count-t.count}),{aspect:Object(x.getFromNum)(x.map,{dimension:e.aspect}),keypoint:Object(x.getFromNum)(x.map,{item:e.keypoint}),method:Object(x.getFromNum)(x.map,{detail:e.method}),methodId:e.method,selfId:e.dataId,data:t}})}));case 7:return n=e.sent,e.abrupt("return",n);case 11:e.prev=11,e.t0=e.catch(1),console.log(e.t0);case 14:case"end":return e.stop()}},e,null,[[1,11]])}));return function(){return e.apply(this,arguments)}}(),Ne=function(){var e=we(regeneratorRuntime.mark(function e(){var t,r,n,a=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:{},e.prev=1,e.next=4,G.findAll({where:{dataId:t.dataId,aspect:t.aspect,keypoint:t.keypoint,method:t.method},attributes:["aspect","keypoint","method","dataId"],group:["method"]}).then(function(e){return e.map(function(e){return e.dataValues})});case 4:return r=e.sent,e.next=7,Promise.all(r.map(function(e){return G.count({attributes:["dataId"],where:{aspect:e.aspect,keypoint:e.keypoint,method:e.method},group:["dataId"]}).then(function(t){return t=t.sort(function(e,t){return e.count-t.count}),{aspect:Object(x.getFromNum)(x.map,{dimension:e.aspect}),keypoint:Object(x.getFromNum)(x.map,{item:e.keypoint}),method:Object(x.getFromNum)(x.map,{detail:e.method}),methodId:e.method,selfId:e.dataId,data:t}})}));case 7:return n=e.sent,e.abrupt("return",n);case 11:e.prev=11,e.t0=e.catch(1),console.log(e.t0);case 14:case"end":return e.stop()}},e,null,[[1,11]])}));return function(){return e.apply(this,arguments)}}();function Re(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function Oe(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){Re(o,n,a,s,c,"next",e)}function c(e){Re(o,n,a,s,c,"throw",e)}s(void 0)})}}var Fe=s.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});Fe.get("/index",function(){var e=Oe(regeneratorRuntime.mark(function e(t,r){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{n=Object(x.getFromNum)(x.map,{type:r.locals.typeId}),a=Object(x.getFromNum)(x.map,{type:r.locals.typeId,campus:r.locals.campusId}),r.render("manage/graph",{GLOBAL:{channel:{id:"mid-long-term",name:"中長程計畫"},id:t.session.userId,user:r.locals.user,type:{id:r.locals.typeId,name:n},campus:{id:r.locals.campusId,name:a},graph:"統計圖表"}})}catch(e){console.log(e)}case 1:case"end":return e.stop()}},e)}));return function(t,r){return e.apply(this,arguments)}}()),Fe.get("/filter",function(){var e=Oe(regeneratorRuntime.mark(function e(t,r){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"All"!=t.query.aspect){e.next=7;break}return e.next=4,be({dataId:r.locals.dataId});case 4:n=e.sent,e.next=23;break;case 7:if("All"!=t.query.keypoint){e.next=13;break}return e.next=10,xe({aspect:Object(x.getFromWord)(x.map,{dimension:t.query.aspect}),dataId:r.locals.dataId});case 10:n=e.sent,e.next=23;break;case 13:if("All"!=t.query.method){e.next=19;break}return e.next=16,ke({dataId:r.locals.dataId,aspect:Object(x.getFromWord)(x.map,{dimension:t.query.aspect}),keypoint:Object(x.getFromWord)(x.map,{item:t.query.keypoint})});case 16:n=e.sent,e.next=23;break;case 19:if(!t.query.method){e.next=23;break}return e.next=22,Ne({dataId:r.locals.dataId,aspect:Object(x.getFromWord)(x.map,{dimension:t.query.aspect}),keypoint:Object(x.getFromWord)(x.map,{item:t.query.keypoint}),method:Object(x.getFromWord)(x.map,{detail:t.query.method})});case 22:n=e.sent;case 23:return e.next=25,P.findOne({where:{dataId:r.locals.dataId},attributes:["yearFrom","yearTo"]}).then(function(e){return e.dataValues});case 25:a=e.sent,r.json({data:n,year:{yearFrom:a.yearFrom,yearTo:a.yearTo}}),e.next=32;break;case 29:e.prev=29,e.t0=e.catch(0),console.log(new Error(e.t0));case 32:case"end":return e.stop()}},e,null,[[0,29]])}));return function(t,r){return e.apply(this,arguments)}}());var je=Fe;function Te(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}var Pe=s()();Pe.set("views",l.a.join(f.a.projectRoot,"mid-long-term/views")),Pe.set("view engine","pug"),Pe.use("/static",s.a.static("".concat(f.a.projectRoot,"/mid-long-term/public"),{cacheControl:!1,dotfiles:"ignore",etag:!1,extensions:["css","js"],fallthrough:!0,immutable:!1,index:!1,lastModified:!1,maxAge:0,redirect:!1,setHeaders:function(e,t,r){e.set("x-timestamp",Date.now())}})),Pe.use("/",function(){var e,t=(e=regeneratorRuntime.mark(function e(t,r,n){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.session||!t.session.userId){e.next=8;break}return e.next=3,b.findOne({where:{userId:t.session.userId}});case 3:null!=(a=e.sent)&&(r.locals.user=a.dataValues.account),n(),e.next=9;break;case 8:r.redirect("/auth/login");case 9:case"end":return e.stop()}},e)}),function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){Te(o,n,a,s,c,"next",e)}function c(e){Te(o,n,a,s,c,"throw",e)}s(void 0)})});return function(e,r,n){return t.apply(this,arguments)}}()),Pe.use("/",z),Pe.use("/:typeId",function(e,t,r){t.locals.typeId=Number(e.params.typeId),r()},te),Pe.use("/:typeId/:campusId",function(e,t,r){t.locals.campusId=Number(e.params.campusId),r()},ae),Pe.use("/:typeId/:campusId/:dataId",function(e,t,r){t.locals.dataId=Number(e.params.dataId),r()}),Pe.use("/:typeId/:campusId/:dataId/graph",je),Pe.use("/:typeId/:campusId/:dataId/download",Ie),Pe.use("/:typeId/:campusId/:dataId/file",ie),Pe.use("/:typeId/:campusId/:dataId/content",le),Pe.use("/:typeId/:campusId/:dataId/review",X);var Se=Pe;function Ee(e){if(null==e)throw new TypeError("Cannot destructure undefined")}function Ge(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}var Ae=s()();y.authenticate().then(function(){console.log("Connection has been established successfully")}).catch(function(e){console.error("Unable to connect to the database",e)}),a.a.createServer(Ae),Ae.listen(f.a.server.port),Ae.use(d()()),Ae.use(s.a.json({inflate:!0,limit:"5GB",strict:!0,type:"application/json"})),Ae.use(s.a.urlencoded({extended:!0,inflate:!0,limit:"5GB",parameterLimit:1e3,type:["application/x-www-form-urlencoded","multipart/form-data","text/html","application/xhtml+xml","application/xml"]})),Ae.use(i()({cookie:{path:"/",httpOnly:!0,domain:f.a.server.domain,expires:new Date(Date.now()+6048e5),maxAge:6048e5,sameSite:!0},name:"sekiro",proxy:!1,secret:f.a.server.secret,resave:!1,rolling:!1,saveUninitialized:!1,unset:"destroy"})),Ae.use(function(){var e,t=(e=regeneratorRuntime.mark(function e(t,r,n){var a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(Ee(r),(a=d.a.signedCookies(t.cookies,f.a.server.secret).sekiro)===t.session.id){e.next=16;break}return e.next=5,I.findOne({where:{sessionId:a}});case 5:if(null===(o=e.sent)){e.next=16;break}if(!(Number(o.expiration)>Date.now())){e.next=13;break}return t.session.userId=o.userId,e.next=11,o.update({sessionId:t.session.id});case 11:e.next=16;break;case 13:if(!(Number(o.expiration)<Date.now())){e.next=16;break}return e.next=16,o.destroy();case 16:n();case 17:case"end":return e.stop()}},e)}),function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){Ge(o,n,a,s,c,"next",e)}function c(e){Ge(o,n,a,s,c,"throw",e)}s(void 0)})});return function(e,r,n){return t.apply(this,arguments)}}()),Ae.use("/auth",O),Ae.use("/mid-long-term",Se),Ae.use(function(e,t,r){e.session.userId?e.session&&e.session.userId?t.redirect("/mid-long-term/".concat(e.session.userId,"/index")):r():t.redirect("/auth/login")})}]);