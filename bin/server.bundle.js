!function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(n,o,function(r){return e[r]}.bind(null,o));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=9)}([function(e,r){e.exports=require("express")},function(e,r){e.exports={database:{database:"sinicaUser",host:"140.116.245.105",port:33060,user:"eechen",password:"123"},server:{domain:"localhost",port:3e3,secret:"deepest and darkest secret"},projectRoot:"/home/nober/git/selection_Web"}},function(e,r){e.exports=require("sequelize")},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("cookie-parser")},function(e,r){e.exports=require("http")},function(e,r){e.exports=require("express-session")},function(e,r){e.exports=require("morgan")},function(e,r){e.exports=require("fs")},function(e,r,t){t(10),e.exports=t(12)},function(e,r){e.exports=require("babel-polyfill")},function(e,r){e.exports=require("compression")},function(e,r,t){"use strict";t.r(r);var n=t(5),o=t.n(n),s=t(0),a=t.n(s),i=(t(11),t(6)),u=t.n(i),c=t(4),p=t.n(c),d=(t(7),t(3)),l=t.n(d),f=t(1),m=t.n(f),v=t(2),g=t.n(v),h=new g.a("sinicaUser","".concat(m.a.database.user),"".concat(m.a.database.password),{host:"".concat(m.a.database.host),port:m.a.database.port,dialect:"mysql",omitNull:!0,native:!0,logging:!1,define:{underscored:!0,charset:"utf-8",freezeTableName:!0,dialectOptions:{collate:"utf8mb4_general_ci"},timestamps:!1},operatorsAliases:!1,sync:{force:!1},pool:{max:5,min:0,acquire:3e4,idle:3e4}}),x=h.define("session",{tableId:{type:g.a.INTEGER(32).UNSIGNED,primaryKey:!0,allowNull:!1,unique:!0,autoIncrement:!0},sessionId:{type:g.a.STRING(45),allowNull:!1,unique:!0},expiration:{type:g.a.STRING(45),allowNull:!1},userId:{type:g.a.INTEGER(32).UNSIGNED,allowNull:!1}}),y=t(8),w=t.n(y),I=h.define("user",{userId:{type:g.a.INTEGER(32).UNSIGNED,primaryKey:!0,allowNull:!1,unique:!0,autoIncrement:!0},account:{type:g.a.STRING(20),allowNull:!1,unique:!0},password:{type:g.a.STRING(20),allowNull:!1}});function b(e,r,t,n,o,s,a){try{var i=e[s](a),u=i.value}catch(e){return void t(e)}i.done?r(u):Promise.resolve(u).then(n,o)}function R(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var s=e.apply(r,t);function a(e){b(s,n,o,a,i,"next",e)}function i(e){b(s,n,o,a,i,"throw",e)}a(void 0)})}}var k=a.a.Router();k.get("/login",function(e,r){r.redirect("/mid-long-term/0/index")}),k.get("/mid-long-term",function(e,r){r.redirect("/mid-long-term/".concat(e.session.userId,"/index"))}),k.get("/shortTerm",function(e,r){r.session&&e.session.userId?r.redirect("/shortTerm/".concat(e.session.userId,"/index")):r.render("login")}),k.post("/login",function(){var e=R(regeneratorRuntime.mark(function e(r,t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,I.findOne({where:{account:r.body.username,password:r.body.password}});case 3:if(null==(n=e.sent)){e.next=10;break}r.session.userId=n.dataValues.userId,x.create({sessionId:r.session.id,expiration:Number(r.session.cookie.expires),userId:n.userId}),t.redirect("/man/".concat(r.session.userId)),e.next=11;break;case 10:throw new Error("No account matched ".concat(r.body.username));case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),t.status(400).render("login",{error:e.t0.message});case 16:case"end":return e.stop()}},e,null,[[0,13]])}));return function(r,t){return e.apply(this,arguments)}}()),k.get("/logout",function(){var e=R(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,x.destroy({where:{sessionId:r.session.id}});case 3:return e.next=5,new Promise(function(e,t){r.session.destroy(function(r){r&&t(r),e()})}).catch(function(e){throw e});case 5:t.status(200).redirect("/auth/login"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),t.status(404).render("error",{message:e.t0.message,error:{status:"404",stack:"error"}});case 11:case"end":return e.stop()}},e,null,[[0,8]])}));return function(r,t){return e.apply(this,arguments)}}()),k.get("/signup",function(e,r){r.render("signup")}),k.post("/signup",function(){var e=R(regeneratorRuntime.mark(function e(r,t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=new RegExp("<script[sS]*?>[sS]*?<\/script>","gi"),e.prev=1,!n.test(r.body.username)&&!n.test(r.body.password)){e.next=4;break}throw new Error("Forbidden password or account");case 4:return e.next=6,I.create({account:r.body.username,password:r.body.password});case 6:if(!e.sent){e.next=10;break}return e.next=10,new Promise(function(e,t){w.a.mkdir("data/".concat(r.body.username),{recursive:!0},function(r){r&&t(r),e(!0)})});case 10:t.status(200).send("OK"),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(1),t.status(400).render("signup",{error:e.t0.message});case 16:case"end":return e.stop()}},e,null,[[1,13]])}));return function(r,t){return e.apply(this,arguments)}}());var N=k,j=a.a.Router();j.get("/index",function(e,r){r.render("index",{})});var P=j,S=a.a.Router();S.get("/",function(e,r){r.render("type")});var q=S,T=a.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});T.get("/",function(e,r){r.render("campus")});var E=T,G=a.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});G.get("/index",function(e,r){r.render("year")}),G.get("/review",function(e,r){}),G.get("/edit",function(e,r){}),G.delete("/delete",function(e,r){}),G.get("/download",function(e,r){}),G.get("/graph",function(e,r){});var O=G;function D(e,r,t,n,o,s,a){try{var i=e[s](a),u=i.value}catch(e){return void t(e)}i.done?r(u):Promise.resolve(u).then(n,o)}function _(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var s=e.apply(r,t);function a(e){D(s,n,o,a,i,"next",e)}function i(e){D(s,n,o,a,i,"throw",e)}a(void 0)})}}var U=a.a.Router({caseSensitive:!0,mergeParams:!1,strict:!1});U.post("/add",function(){var e=_(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},e)}));return function(r,t){return e.apply(this,arguments)}}()),U.delete("/delete",function(){var e=_(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},e)}));return function(r,t){return e.apply(this,arguments)}}());var M=U;function C(e,r,t,n,o,s,a){try{var i=e[s](a),u=i.value}catch(e){return void t(e)}i.done?r(u):Promise.resolve(u).then(n,o)}function A(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var s=e.apply(r,t);function a(e){C(s,n,o,a,i,"next",e)}function i(e){C(s,n,o,a,i,"throw",e)}a(void 0)})}}var z=a()();z.set("views",l.a.join(m.a.projectRoot,"mid-long-term/views")),z.set("view engine","pug"),z.use("/static",a.a.static(l.a.join(m.a.projectRoot,"mid-long-term/publics"),{cacheControl:!1,dotfiles:"ignore",etag:!1,extensions:["css","js"],fallthrough:!0,immutable:!1,index:!1,lastModified:!1,maxAge:0,redirect:!1,setHeaders:function(e){e.set("x-timestamp",Date.now())}})),z.use("/:userId",function(e,r,t){t()}),z.use("/:userId",P),z.use("/:userId/file",M),z.use("/:userId/:typeId",function(){var e=A(regeneratorRuntime.mark(function e(r,t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.locals.typeId=r.params.typeId,n();case 2:case"end":return e.stop()}},e)}));return function(r,t,n){return e.apply(this,arguments)}}(),q),z.use("/:userId/:typeId/:campusId",function(){var e=A(regeneratorRuntime.mark(function e(r,t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.locals.campusId=r.params.campusId,n();case 2:case"end":return e.stop()}},e)}));return function(r,t,n){return e.apply(this,arguments)}}(),E),z.use("/:userId/:typeId/:campusId/:year",function(){var e=A(regeneratorRuntime.mark(function e(r,t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.locals.year=r.params.year,n();case 2:case"end":return e.stop()}},e)}));return function(r,t,n){return e.apply(this,arguments)}}(),O);var K=z;function B(e,r,t,n,o,s,a){try{var i=e[s](a),u=i.value}catch(e){return void t(e)}i.done?r(u):Promise.resolve(u).then(n,o)}function H(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var s=e.apply(r,t);function a(e){B(s,n,o,a,i,"next",e)}function i(e){B(s,n,o,a,i,"throw",e)}a(void 0)})}}var F=a()();F.set("views",l.a.join(m.a.projectRoot,"shortTerm/views")),F.set("view engine","pug"),F.use("/static",a.a.static(l.a.join(m.a.projectRoot,"shortTerm/publics"),{cacheControl:!1,dotfiles:"ignore",etag:!1,extensions:["css","js"],fallthrough:!0,immutable:!1,index:!1,lastModified:!1,maxAge:0,redirect:!1,setHeaders:function(e){e.set("x-timestamp",Date.now())}})),F.use("/:userId",function(e,r,t){r.session&&r.session.userId==e.params.userId?t():r.redirect("/auth/login")}),F.use("/:userId",P),F.use("/:userId/file",M),F.use("/:userId/:typeId",function(){var e=H(regeneratorRuntime.mark(function e(r,t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.locals.typeId=r.params.typeId,n();case 2:case"end":return e.stop()}},e)}));return function(r,t,n){return e.apply(this,arguments)}}(),q),F.use("/:userId/:typeId/:campusId",function(){var e=H(regeneratorRuntime.mark(function e(r,t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.locals.campusId=r.params.campusId,n();case 2:case"end":return e.stop()}},e)}));return function(r,t,n){return e.apply(this,arguments)}}(),E),F.use("/:userId/:typeId/:campusId/:year",function(){var e=H(regeneratorRuntime.mark(function e(r,t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.locals.year=r.params.year,n();case 2:case"end":return e.stop()}},e)}));return function(r,t,n){return e.apply(this,arguments)}}(),O);function L(e){if(null==e)throw new TypeError("Cannot destructure undefined")}function V(e,r,t,n,o,s,a){try{var i=e[s](a),u=i.value}catch(e){return void t(e)}i.done?r(u):Promise.resolve(u).then(n,o)}var W=a()();h.authenticate().then(function(){console.log("Connection has been established successfully")}).catch(function(e){console.error("Unable to connect to the database",e)}),o.a.createServer(W),W.listen(m.a.server.port),W.use(p()()),W.use(a.a.json({inflate:!0,limit:"5GB",strict:!0,type:"application/json"})),W.use(a.a.urlencoded({extended:!0,inflate:!0,limit:"5GB",parameterLimit:1e3,type:["application/x-www-form-urlencoded","multipart/form-data","text/html","application/xhtml+xml","application/xml"]})),W.use(u()({cookie:{path:"/",httpOnly:!0,domain:m.a.server.domain,expires:new Date(Date.now()+6048e5),maxAge:6048e5,sameSite:!0},name:"sekiro",proxy:!1,secret:m.a.server.secret,resave:!1,rolling:!1,saveUninitialized:!1,unset:"destroy"})),W.use(function(){var e,r=(e=regeneratorRuntime.mark(function e(r,t,n){var o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(L(t),(o=p.a.signedCookies(r.cookies,m.a.server.secret).sekiro)===r.session.id){e.next=16;break}return e.next=5,x.findOne({where:{sessionId:o}});case 5:if(null===(s=e.sent)){e.next=16;break}if(!(Number(s.expiration)>Date.now())){e.next=13;break}return r.session.userId=s.userId,e.next=11,s.update({sessionId:r.session.id});case 11:e.next=16;break;case 13:if(!(Number(s.expiration)<Date.now())){e.next=16;break}return e.next=16,s.destroy();case 16:n();case 17:case"end":return e.stop()}},e)}),function(){var r=this,t=arguments;return new Promise(function(n,o){var s=e.apply(r,t);function a(e){V(s,n,o,a,i,"next",e)}function i(e){V(s,n,o,a,i,"throw",e)}a(void 0)})});return function(e,t,n){return r.apply(this,arguments)}}()),W.use("/auth",N),W.use("/mid-long-term",K)}]);