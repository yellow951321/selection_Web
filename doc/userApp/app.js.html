<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file The Auth app root route
 * @module userApp
 * @name userApp
 * @requires express
 * @requires path
 * @requires cookie-parser
 * @requires 'auth/models/schemas/user.js'
 * @requires 'auth/models/schemas/session.js'
 * @requires 'auth/models/operations/sync-session.js'
 */
/**
 * express module
 * @const {Module} express
 * @see https://expressjs.com/zh-tw/
 */
import express from 'express'
/**
 * path moduel
 * @const {Module} path
 * @see https://nodejs.org/docs/latest/api/path.html
 */
import path from 'path'
/**
 * cookie-parser module
 * @const {Module} cookieParser
 * @see https://www.npmjs.com/package/cookie-parser
 */
import cookieParser from 'cookie-parser'
/**
 * User schema
 * @const {Module} User
 */
import User from 'auth/models/schemas/user.js'
/**
 * Session schema
 * @const {Module} Session
 */
import Session from 'auth/models/schemas/session.js'
/**
 * Config file
 * @const {Module} config
 */
import config from 'projectRoot/config.js'
/**
 * import the function syncSession
 * @const {Module} syncSession
 */
import syncSession from 'auth/models/operations/sync-session.js'

/**
 * Express router to mount user related functions on.
 * @constant {Express()} app
 */
const app = express()

/**
 * define a property named GLOBAL in app.locals
 * @member {app.locals} GLOBAL
 */
app.locals.GLOBAL = {
  config,
}
/**
 * Set the views to the specified directory: views -> auth/views
 * @name set/views
 * @function
 * @memberof module:userApp
 * @inner
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware
 */
app.set('views', path.join(config.projectRoot, 'auth/views'))
// Define the `view engine` to `pug(jade)`
/**
 * Sefine the `view engine` to `pug(jade)`
 * @name set/view_engine
 * @inner
 * @function
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware
 */
app.set('view engine', 'pug')
/**
 * Mounts the /public route path to a static directory
 * @name use/public
 * @inner
 * @function
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware
 */
app.use('/public', express.static(`${config.projectRoot}/auth/public`, {
  cacheControl: false,
  // 404 for request dot files
  dotfiles: 'ignore',
  // disable cache
  etag: false,
  // handle missing extension for static file
  extensions: ['css', 'js', ],
  // when 404, pass handle to other middleware
  fallthrough: true,
  // static file can be cached
  immutable: false,
  // index file not exist
  index: false,
  // disable cache
  lastModified: false,
  // disable cache
  maxAge: 0,
  // do not redirect to trailing '/'
  redirect: false,
  // add timestamp for test
  setHeaders(res){
    res.set('x-timestamp', Date.now())
  },
}))
/**
 * check the sessionId in the cookie if its status is 'login' (stored in database) automatically login
 * @name use/cookieParser
 * @inner
 * @function
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware
 */
app.use(async(req, {}, next) => {
  try {
    // Parse a cookie value as a signed cookie
    let sessionId = cookieParser.signedCookies(req.cookies, config.server.secret)['sekiro']
    // check the request session with syncSession
    await syncSession(req, sessionId)
    // pass this request to the next route
    next()
  }
  catch (err) {
    if(err.status)
      next(err)
    else {
      err = new Error('Failed to setup session.')
      err.status = 500
      next(err)
    }
  }
})

/**
 * The login route
 * @name route/login
 * @inner
 * @function
 * @param {string} path - Express path
 */
app.route('/login')
  // if the request have been loginned, it will redirect to /auth/channel/
  .get(async(req, res, next)=>{
    try {
      if(req.session &amp;&amp; req.session.userId)
        res.redirect('/auth/channel')
      else
        res.render('login')
    }
    catch(err){
      if(err.status)
        next(err)
      else {
        err = new Error('Failed to GET at route `/auth/login`.')
        next(err)
      }
    }
  })
  // if the request hasn't loginned, create a session to this user
  .post(async(req, res, next)=>{
    try{
      // find the user whether it has sign up in database
      const data = await User.findOne({
        where:{
          account: req.body.username,
          password: req.body.password,
        },
      })
      if(data != null){
        // create a session of the user to the database
        req.session.userId = data.userId
        Session.create({
          sessionId: req.session.id,
          expiration: Number(req.session.cookie.expires),
          userId: data.userId,
        })
        // redirect to /auth/login
        res.redirect('/auth/login')
      }else{
        // error handling
        const err = new Error(`No account matched ${req.body.username}.`)
        err.status = 401
        throw err
      }
    }
    catch(err){
      // error handling
      if(err.status)
        next(err)
      else {
        err = new Error('Failed to perform POST at route `/auth/login`')
        err.status = 400
        next(err)
      }
    }
  })

/**
 * The /channel route
 * @name route/channel
 * @inner
 * @function
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware
 */
app.get('/channel', async(req, res, next)=> {
  try {
    if(req.session &amp;&amp; req.session.userId){ // check the session whether is existed.
      // find the information of the user
      let user = await User.findOne({
        where:{
          userId: req.session.userId,
        },
      })
      // render a channel page back
      res.render('channel', {
        user: user.account,
      })
    }
    else
      // if not, redirect to /auth/channel
      res.redirect('/auth/channel')
  }
  catch (err){
    // error handling
    next(err)
  }
})

/**
 * The /logout route
 * @name route/logout
 * @inner
 * @function
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware
 */
app.get('/logout', async(req, res, next)=>{
  try {
    // remove session and remove the login record in the database
    await Session.destroy({
      where: {
        sessionId: req.session.id,
      },
    })
    // remove the session in the request
    req.session.destroy()
    // redirect to /auth/login
    res.redirect('/auth/login')
  } catch (err) {
    // error handling - pass to the error handling route
    if(err.status)
      next(err)
    else {
      err = new Error('Failed to GET at route `/auth/logout`.')
      err.status = 500
      next(err)
    }
  }
})
/**
 * @todo need to be remove in the future
 * @name route/signup
 * @inner
 * @function
 * @param {string} path - Express path
 */
app.route('/signup')
  .get(({}, res, next)=>{
    try {
      res.render('signup')
    }
    catch (err) {
      if(err.status)
        next(err)
      else {
        err = new Error('Failed to GET at route `/auth/singup`')
        err.status = 500
        next(err)
      }
    }
  })
  .post(async(req, res, next)=>{
    try{
      const user = await User.create({
        account : req.body.account,
        password: req.body.password,
      })
      if(user)
        res.redirect('/auth/login')
      else
        throw new Error()
    }
    catch (err){
      if(err.status)
        next(err)
      else {
        err = new Error('Failed to POST at route `/auth/signup`.')
        err.status = 500
        next(err)
      }
    }
  })
/**
 * The error handling route
 * @name route/errorHandling
 * @inner
 * @function
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware
 */
app.use(({}, {}, next)=>{
  // create a error message with page not found
  const err = new Error('Page not found.')
  err.status = 404
  next(err)
})
/**
 * The error handling route used to render the error page
 * @name route/errorRender
 * @inner
 * @function
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware
 */
app.use((err, {}, res, {})=>{
  // render the error page
  res.render('error', err)
})


export default app</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-userApp.html">userApp</a></li></ul><h3>Interfaces</h3><ul><li><a href="UserDB.html">UserDB</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Session">Session</a></li><li><a href="global.html#syncSession">syncSession</a></li><li><a href="global.html#User">User</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.2</a> on Fri Jul 05 2019 12:11:29 GMT+0800 (Taipei Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
